# 下一步操作

## 一、问题总结与解决方案

### 1. Node.js 环境问题
**问题**: `node` 命令无法识别
**状态**: 未解决，但前端已通过其他方式启动
**建议**: 如需本地开发，请安装 Node.js 并添加到 PATH

---

### 2. 前端依赖缺失
**问题**: 前端缺少 `axios` 库（用于发送 HTTP 请求）
**解决**: 执行 `npm install axios`
**状态**: ✅ 已解决

---

### 3. CORS 跨域问题
**问题**: 前端 (localhost:5173) 无法访问后端 (localhost:8000)，浏览器阻止跨域请求
**错误信息**: `net::ERR_FAILED http://localhost:8000/video/feed`
**解决**: 在 `app/main.py` 添加 CORS 中间件
**状态**: ✅ 已解决

---

### 4. 视频路径不匹配问题 ⚠️ 重要
**问题**: 视频保存目录和静态文件访问目录不一致
- 保存目录: `video_storage` (config.py)
- 访问目录: `uploaded_videos` (main.py)
**解决**: 暂时改为使用 `uploaded_videos`（因为现有视频文件在该目录）
**状态**: ⚠️ 需要统一（见下方"后续检查"）

---

### 5. 数据库表结构不完整
**问题**: `videos` 表缺少 `target_type` 和 `target_id` 列
**错误信息**: `no such column: videos.target_type`
**解决**: 执行 SQL 添加列
```sql
ALTER TABLE videos ADD COLUMN target_type VARCHAR;
ALTER TABLE videos ADD COLUMN target_id VARCHAR;
```
**状态**: ✅ 已解决

---

### 6. 数据库视频路径为空
**问题**: 数据库中视频记录的 `file_path` 为空
**解决**: 手动更新为完整URL: `/videos/3444cc98710940e8be6a866007a2fc5f.mp4`
**状态**: ✅ 已解决（临时方案）

---

## 二、修改的文件

### 永久修改（需保留）
| 文件 | 修改内容 |
|------|----------|
| `jobvideo_backend/app/main.py` | 添加 CORS 中间件 |
| `jobvideo_backend/app/main.py` | 修改静态文件目录为 `uploaded_videos` |

### 数据库修改
| 表 | 修改内容 |
|----|----------|
| `videos` | 添加 `target_type` 列 |
| `videos` | 添加 `target_id` 列 |
| `videos` | 更新 ID=1 的 `file_path` |

---

### 临时文件（可删除）
| 文件 | 用途 | 是否可删除 |
|------|------|-----------|
| `jobvideo_backend/check_db.py` | 检查数据库表 | ✅ 可删除 |
| `jobvideo_backend/check_videos.py` | 检查视频记录 | ✅ 可删除 |
| `jobvideo_backend/check_table_structure.py` | 检查表结构 | ✅ 可删除 |
| `jobvideo_backend/add_columns.py` | 添加数据库列 | ✅ 可删除 |
| `jobvideo_backend/update_video_path.py` | 更新视频路径 | ✅ 可删除 |

---

## 三、后续检查与优化

### 1. 视频路径统一问题 ⚠️ 高优先级

**当前状态**:
- `app/config.py`: `VIDEO_STORAGE_DIR = "video_storage"`
- `app/main.py`: `StaticFiles(directory="uploaded_videos")`
- 现有视频文件: `uploaded_videos/3444cc98710940e8be6a866007a2fc5f.mp4`

**建议方案**:

**方案 A: 统一使用 `video_storage`**
```python
# app/config.py
VIDEO_STORAGE_DIR = "video_storage"

# app/main.py
app.mount("/videos", StaticFiles(directory="video_storage"), name="videos")
```
然后移动现有视频文件:
```bash
mv uploaded_videos/*.mp4 video_storage/
```

**方案 B: 统一使用 `uploaded_videos`**
```python
# app/config.py
VIDEO_STORAGE_DIR = "uploaded_videos"

# app/main.py
app.mount("/videos", StaticFiles(directory="uploaded_videos"), name="videos")
```

**推荐**: 方案 B（因为现有文件已在该目录）

---

### 2. 视频上传后自动设置完整路径

**当前问题**: 视频上传后 `file_path` 需要手动更新为完整URL

**建议**: 修改 `app/video/routes.py` 的 `upload_video` 函数
```python
# 保存文件后
file_path = await utils.save_video_file(file)

# 改为完整URL
file_path_url = f"/videos/{os.path.basename(file_path)}"

# 创建视频记录时使用完整URL
video = models.Video(
    title=title,
    description=description,
    file_path=file_path_url,  # 使用完整URL
    filename=os.path.basename(file_path),
    ...
)
```

---

### 3. 检查视频编码格式

**要求**: 视频编码应为 H.264 + AAC（浏览器兼容性最好）

**检查方法**:
```bash
# 使用 ffprobe 检查视频编码
ffprobe -v error -select_streams v:0 -show_entries stream=codec_name -of default=noprint_wrappers=1:nokey=1 uploaded_videos/3444cc98710940e8be6a866007a2fc5f.mp4
```

**如果编码不是 H.264 + AAC**:
- 需要使用 FFmpeg 转码
- 或在上传时验证编码格式

---

### 4. 检查手机访问

**步骤**:
1. 获取电脑IP地址: `ipconfig` (Windows) 或 `ifconfig` (Mac/Linux)
2. 确保手机和电脑在同一WiFi网络
3. 手机浏览器访问: `http://电脑IP:5173/`
4. 测试视频播放

**如果无法访问**:
- 检查防火墙设置
- 确保前端服务器允许外部访问（可能需要 `npm run dev -- --host`）

---

### 5. 检查 CORS 配置

**当前配置**:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 允许所有来源（生产环境应限制）
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**生产环境建议**:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://your-frontend-domain.com"],  # 限制具体域名
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)
```

---

## 四、清理临时文件

执行以下命令删除临时文件:
```powershell
cd c:\Coding\JobVideo_Platform\jobvideo_backend
Remove-Item check_db.py, check_videos.py, check_table_structure.py, add_columns.py, update_video_path.py
```

---

## 五、测试清单

- [ ] 前端能正常加载视频列表
- [ ] 视频能正常播放
- [ ] 手机浏览器能访问并播放视频
- [ ] 上传新视频后能正常播放
- [ ] 视频路径统一配置完成
- [ ] CORS 配置符合生产环境要求
- [ ] 视频编码格式检查通过
